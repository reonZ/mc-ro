{"mappings":"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","sources":["src/main.ts","../../../../Projects/foundry-ts/utils/libwrapper.ts","src/module.ts","src/chat.ts","../../../../Projects/foundry-ts/utils/foundry/notifications.ts","../../../../Projects/foundry-ts/utils/foundry/i18n.ts","src/macro.ts","../../../../Projects/foundry-ts/utils/function.ts","src/utils.ts","src/html.ts"],"sourcesContent":["import { registerWrapper } from './@utils/libwrapper'\r\nimport { onChatMessage } from './chat'\r\nimport { onDragLink, enrichHTML, onMacroClick } from './html'\r\nimport { createLink, executeMacro } from './macro'\r\n\r\nconst TEXTEDITOR_ENRICH = 'TextEditor.enrichHTML'\r\nconst TEXTEDITOR_DRAG = 'TextEditor._onDragContentLink'\r\nconst MACRO_CLICK = 'Macro.prototype._onClickDocumentLink'\r\nconst MACRO_CREATE_LINK = 'Macro.prototype._createDocumentLink'\r\n\r\nHooks.once('libWrapper.Ready', () => {\r\n    registerWrapper(TEXTEDITOR_ENRICH, enrichHTML)\r\n    registerWrapper(TEXTEDITOR_DRAG, onDragLink, 'MIXED')\r\n    registerWrapper(MACRO_CLICK, onMacroClick, 'MIXED')\r\n    registerWrapper(MACRO_CREATE_LINK, createLink, 'MIXED')\r\n})\r\n\r\nHooks.once('ready', () => {\r\n    patchPf2e()\r\n    // @ts-ignore\r\n    game.macros.executeMacro = executeMacro\r\n})\r\n\r\nHooks.on('chatMessage', onChatMessage)\r\n\r\nfunction patchPf2e() {\r\n    if (game.system.id !== 'pf2e') return\r\n    if (isNewerVersion(game.system.version, '4.4.2')) return\r\n    if (!game.pf2e || !game.pf2e.TextEditor) return\r\n\r\n    // @ts-ignore\r\n    game.pf2e.TextEditor.enrichHTML = (...args: Parameters<typeof TextEditorPF2e['enrichHTML']>) => {\r\n        return TextEditor.enrichHTML(...args)\r\n    }\r\n}\r\n","import MODULE_ID from '~./src/module'\r\n\r\nexport function registerWrapper(\r\n    target: string,\r\n    fn: libWrapper.RegisterFunction,\r\n    type: 'WRAPPER' | 'MIXED' | 'OVERRIDE' = 'WRAPPER'\r\n) {\r\n    libWrapper.register(MODULE_ID, target, fn, type)\r\n}\r\n","export default 'mc-ro'","import { warn } from './@utils/foundry/notifications'\r\nimport { executeMacro } from './macro'\r\nimport { tokenize } from './utils'\r\n\r\nconst MACRO = /^\\/m(?:acro)?(?<command>[^\\n]*)/i\r\n\r\nexport function onChatMessage(log: ChatLog, message: string, chatData: ChatData) {\r\n    const match = message.trim().match(MACRO)\r\n    if (!match?.groups) return\r\n\r\n    const args = tokenize(match.groups.command)\r\n    if (args.length) {\r\n        const id = args.splice(0, 1)[0]\r\n        executeMacro(id, args)\r\n    } else {\r\n        warn('invalid')\r\n    }\r\n\r\n    return false\r\n}\r\n","import { localize } from './i18n'\r\n\r\nexport function notify(\r\n    str: string,\r\n    arg1?: 'warning' | 'info' | 'error' | boolean | Record<string, string>,\r\n    arg2?: boolean | Record<string, string>,\r\n    arg3?: boolean\r\n) {\r\n    const type = typeof arg1 === 'string' ? arg1 : 'info'\r\n    const data = typeof arg1 === 'object' ? arg1 : typeof arg2 === 'object' ? arg2 : undefined\r\n    const permanent = typeof arg1 === 'boolean' ? arg1 : typeof arg2 === 'boolean' ? arg2 : arg3 ?? false\r\n\r\n    ui.notifications.notify(localize(str, data), type, { permanent })\r\n}\r\n\r\nexport function warn(str: string, arg1?: boolean | Record<string, string>, arg2?: boolean) {\r\n    notify(str, 'warning', arg1, arg2)\r\n}\r\n\r\nexport function info(str: string, arg1?: boolean | Record<string, string>, arg2?: boolean) {\r\n    notify(str, 'info', arg1, arg2)\r\n}\r\n\r\nexport function error(str: string, arg1?: boolean | Record<string, string>, arg2?: boolean) {\r\n    notify(str, 'error', arg1, arg2)\r\n}\r\n","import MODULE_ID from '~./src/module'\r\n\r\nexport function localize(key: string, data?: Record<string, string | number>) {\r\n    key = `${MODULE_ID}.${key}`\r\n    if (data) return game.i18n.format(key, data)\r\n    return game.i18n.localize(key)\r\n}\r\n\r\nexport function subLocalize(subKey: string) {\r\n    return (key: string, data?: Record<string, string>) => localize(`${subKey}.${key}`, data)\r\n}\r\n","import { error } from './@utils/foundry/notifications'\r\nimport { AsyncFunction } from './@utils/function'\r\nimport { detokenize } from './utils'\r\n\r\nexport function executeMacro(id: string | number, args: Array<string | number>) {\r\n    let macro: Macro | undefined\r\n    if (Number.isNumeric(id)) {\r\n        const macroId = game.user.hotbar[id]\r\n        macro = game.macros.get(macroId)\r\n    } else {\r\n        macro = game.macros.get(id) ?? game.macros.getName(id)\r\n    }\r\n\r\n    if (!macro) return error('noMacro', { id: id.toString() })\r\n    if (!macro.canExecute) return error('noPermission', { name: macro.name })\r\n    if (macro.type === 'chat') return macro._executeChat()\r\n\r\n    const speaker = ChatMessage.implementation.getSpeaker()\r\n    const character = game.user.character\r\n    const actor = speaker.actor ? game.actors.get(speaker.actor) : null\r\n    const token = speaker.token && canvas.ready ? canvas.tokens.get(speaker.token) : null\r\n\r\n    const fn = new AsyncFunction('speaker', 'actor', 'token', 'character', 'args', macro.command)\r\n    try {\r\n        return fn.call(macro, speaker, actor, token, character, args)\r\n    } catch {\r\n        error('syntaxError')\r\n    }\r\n}\r\n\r\nexport function createLink(wrapped: Macro['_createDocumentLink'], ...args: Parameters<Macro['_createDocumentLink']>) {\r\n    const [data] = args\r\n    if (!data.id || !data.args || !data.name) return wrapped(...args)\r\n\r\n    const tokens = data.args.split(',')\r\n    const macroArgs = detokenize(tokens)\r\n\r\n    return `@Macro[${data.id}](${macroArgs}){${data.name}}`\r\n}\r\n","export const AsyncFunction = async function () {}.constructor as ConstructorOf<(...args: any[]) => Promise<any>>\r\n","const TOKEN = /\"[^\"]+\"|[^\\s\"]+/g\r\n\r\nexport function tokenize(str: string) {\r\n    const match = str.match(TOKEN) ?? []\r\n    return match.map(x => {\r\n        x = x.replace(/^\"/, '')\r\n        x = x.replace(/\"$/, '')\r\n        return Number.isNumeric(x) ? Number(x) : x\r\n    })\r\n}\r\n\r\nexport function detokenize(tokens: Array<string | number>) {\r\n    return tokens.map(x => (typeof x === 'string' && x.includes(' ') ? `\"${x}\"` : x)).join(' ')\r\n}\r\n","import { executeMacro } from './macro'\r\nimport { tokenize } from './utils'\r\n\r\nexport async function enrichHTML(wrapped: typeof TextEditor['enrichHTML'], ...args: Parameters<typeof TextEditor['enrichHTML']>) {\r\n    let [content] = args\r\n    if (!content) return wrapped(...args)\r\n\r\n    const regex = /@Macro\\[(?<id>[^\\]]+)\\]\\((?<arguments>[^\\)]+)\\)(?:{(?<label>[^}]+)})?/g\r\n\r\n    let match: RegExpExecArray | null\r\n    while ((match = regex.exec(content))) {\r\n        const id = match.groups!.id\r\n        const macro = game.macros.get(id) ?? game.macros.getName(id)\r\n        if (!macro) continue\r\n\r\n        const args = tokenize(match.groups!.arguments).join(',')\r\n        const label = match.groups!.label ?? macro.name\r\n\r\n        const a = `<a class=\"content-link\" draggable=\"true\" data-type=\"Macro\" data-name=\"${macro.name}\" data-id=\"${macro.id}\" data-uuid=\"${macro.uuid}\" data-args=\"${args}\"><i class=\"fas fa-terminal\"></i>${label}</a>`\r\n        content = content.replace(match[0], a)\r\n    }\r\n\r\n    args[0] = content\r\n    return wrapped(...args)\r\n}\r\n\r\nexport function onMacroClick(wrapped: Macro['_onClickDocumentLink'], ...args: Parameters<Macro['_onClickDocumentLink']>) {\r\n    const data = (args[0].currentTarget as HTMLElement).dataset\r\n    if (!data.args || !data.id || !data.name) return wrapped(...args)\r\n    executeMacro(data.id, data.args.split(','))\r\n}\r\n\r\nexport function onDragLink(\r\n    wrapped: typeof TextEditor['_onDragContentLink'],\r\n    ...args: Parameters<typeof TextEditor['_onDragContentLink']>\r\n) {\r\n    const [event] = args\r\n    const data = event.currentTarget.dataset\r\n    if (data.type !== 'Macro' || !data.id || !data.args || !data.name) return wrapped(...args)\r\n\r\n    event.stopPropagation()\r\n    event.originalEvent.dataTransfer!.setData('text/plain', JSON.stringify(data))\r\n}\r\n"],"names":[],"version":3,"file":"main.js.map"}